<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #00bfff; /* Deep sky blue */
            --primary-text-color: #E0FFFF; /* Light cyan */
            --background-color: #020a1a;
            --container-bg: rgba(0, 38, 77, 0.2);
            --border-color: rgba(0, 191, 255, 0.3);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--background-color);
            color: var(--primary-text-color);
            overflow: hidden;
            background-image:
                linear-gradient(rgba(0, 191, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 191, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .glow-text {
            text-shadow: 0 0 5px var(--glow-color), 0 0 10px var(--glow-color), 0 0 15px var(--glow-color);
        }

        .glow-border {
            border: 1px solid var(--border-color);
            box-shadow: 0 0 10px var(--glow-color) inset, 0 0 5px var(--glow-color);
        }
        
        .hud-element {
            background-color: var(--container-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            position: absolute;
            box-shadow: 0 0 15px rgba(0,191,255,0.2);
        }

        /* --- Central Orb Animation --- */
        #orb-container {
            perspective: 1000px;
        }

        #orb {
            width: 300px;
            height: 300px;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateOrb 40s linear infinite;
        }

        .ring {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--glow-color);
            box-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color) inset;
            transform-style: preserve-3d;
        }

        .ring:nth-child(1) { transform: rotateY(70deg) rotateX(20deg); animation: rotateRing1 8s ease-in-out infinite alternate; }
        .ring:nth-child(2) { transform: rotateY(-70deg) rotateX(-20deg); animation: rotateRing2 10s ease-in-out infinite alternate; }
        .ring:nth-child(3) { transform: rotateX(90deg); animation: rotateRing3 12s ease-in-out infinite alternate; }

        #core {
            width: 50px;
            height: 50px;
            background: var(--glow-color);
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px 10px var(--glow-color), 0 0 50px 20px rgba(0,191,255,0.5);
            animation: pulseCore 2s ease-in-out infinite;
        }
        
        #orb.listening .ring {
            animation-duration: 2s;
            border-color: #ffde59; /* A gold-ish color for listening */
            box-shadow: 0 0 15px #ffde59, 0 0 30px #ffde59 inset;
        }
        
        #orb.listening #core {
             background: #ffde59;
             box-shadow: 0 0 20px 10px #ffde59, 0 0 50px 20px rgba(255,222,89,0.5);
        }


        @keyframes rotateOrb {
            from { transform: rotateY(0deg) rotateX(10deg); }
            to { transform: rotateY(360deg) rotateX(10deg); }
        }

        @keyframes rotateRing1 {
            from { transform: rotateY(70deg) rotateX(20deg); }
            to { transform: rotateY(90deg) rotateX(50deg); }
        }
        @keyframes rotateRing2 {
            from { transform: rotateY(-70deg) rotateX(-20deg); }
            to { transform: rotateY(-90deg) rotateX(-50deg); }
        }
        @keyframes rotateRing3 {
            from { transform: rotateX(90deg) rotateY(0deg); }
            to { transform: rotateX(70deg) rotateY(45deg); }
        }

        @keyframes pulseCore {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--glow-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00ffff;
        }
        
        /* Loading animation */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--glow-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }


    </style>
</head>
<body class="bg-gray-900 text-cyan-200">

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Main Container -->
    <div id="jarvis-container" class="w-full h-screen p-4 flex flex-col items-center justify-between relative opacity-0 transition-opacity duration-1000">

        <!-- Header -->
        <header class="w-full max-w-7xl flex justify-between items-center hud-element glow-border p-2 rounded-lg">
            <h1 class="text-2xl font-bold glow-text">J.A.R.V.I.S. INTERFACE</h1>
            <div class="text-right">
                <div id="time" class="text-xl"></div>
                <div id="date" class="text-sm"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="w-full flex-grow flex items-center justify-center my-4">
            <div id="orb-container">
                <div id="orb">
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div id="core"></div>
                </div>
            </div>
        </main>
        
        <!-- Log and Status -->
        <div class="w-full max-w-4xl h-48 flex gap-4">
            <div id="log-container" class="flex-grow hud-element glow-border p-4 rounded-lg overflow-y-auto">
                <!-- Log messages will be appended here -->
            </div>
            <div id="status-container" class="w-64 hud-element glow-border p-4 rounded-lg flex flex-col justify-between">
                <div>
                    <h2 class="text-lg glow-text border-b border-[var(--border-color)] pb-1 mb-2">SYSTEM STATUS</h2>
                    <p id="status-text" class="text-center text-xl font-semibold">STANDBY</p>
                </div>
                 <button id="start-btn" class="w-full bg-cyan-500/20 hover:bg-cyan-500/40 text-white font-bold py-2 px-4 rounded-lg glow-border transition-all duration-300">
                    ACTIVATE J.A.R.V.I.S.
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // --- DOM Elements ---
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const logContainer = document.getElementById('log-container');
        const orb = document.getElementById('orb');
        const timeEl = document.getElementById('time');
        const dateEl = document.getElementById('date');
        const loadingOverlay = document.getElementById('loading-overlay');
        const jarvisContainer = document.getElementById('jarvis-container');

        // --- Speech Recognition & Synthesis ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        const synth = window.speechSynthesis;
        let voices = [];
        let jarvisVoice = null;
        let isListening = false;
        let isActivated = false;

        // --- Gemini API Configuration ---
        const API_KEY = "AIzaSyCr-PjQDsi5Oi2d8b40V7ZqZHaVBUrwv-Q"; // Leave blank, handled by the environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-05-20:generateContent?key=${API_KEY}`;

        // --- System Initialization ---
        window.onload = () => {
            if (!SpeechRecognition) {
                alert("Sorry, your browser doesn't support the Web Speech API. Please try Chrome or Edge.");
                return;
            }
            if (!synth) {
                alert("Sorry, your browser doesn't support the Speech Synthesis API.");
                return;
            }
            
            setupVoices();
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = setupVoices;
            }
            
            setInterval(updateDateTime, 1000);
            updateDateTime();

            // Fade in UI
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                jarvisContainer.style.opacity = '1';
                setTimeout(() => loadingOverlay.style.display = 'none', 500);
            }, 1000);
        };

        function setupVoices() {
            voices = synth.getVoices();
            // Try to find a good "JARVIS" voice (British Male)
            jarvisVoice = voices.find(voice => voice.name === 'Google UK English Male') || 
                          voices.find(voice => voice.lang === 'en-GB' && voice.name.includes('Male')) || 
                          voices.find(voice => voice.lang.startsWith('en-') && voice.name.includes('Male')) ||
                          voices[0]; // Fallback to the first available voice
        }

        function updateDateTime() {
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString();
            dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // --- Core Functions ---
        function speak(text, onEndCallback = () => {}) {
            if (synth.speaking) {
                console.error('SpeechSynthesis.speaking');
                return;
            }
            if (text !== '') {
                updateStatus('Speaking');
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = jarvisVoice;
                utterance.pitch = 0.9;
                utterance.rate = 1.1;
                utterance.onend = () => {
                    updateStatus('Thinking');
                    if(onEndCallback) onEndCallback();
                    if(isActivated) startListening(); // Continue listening after speaking
                };
                utterance.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event);
                synth.speak(utterance);
            }
        }
        
        function addLog(speaker, message) {
            const logEntry = document.createElement('p');
            logEntry.innerHTML = `<strong class="glow-text ${speaker === 'J.A.R.V.I.S.' ? 'text-cyan-400' : 'text-white'}">${speaker}:</strong> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(text) {
            statusText.textContent = text.toUpperCase();
            if (text.toLowerCase() === 'listening') {
                orb.classList.add('listening');
            } else {
                orb.classList.remove('listening');
            }
        }
        
        function startListening() {
            if (isListening || synth.speaking) return;
            try {
                recognition.start();
                isListening = true;
                updateStatus('Listening');
            } catch(e) {
                console.error("Recognition start error:", e);
                isListening = false;
            }
        }

        function setupRecognition() {
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                updateStatus('Listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim().toLowerCase();
                addLog('User', transcript);
                processCommand(transcript);
            };

            recognition.onerror = (event) => {
                console.error(`Speech recognition error: ${event.error}`);
                if (event.error === 'no-speech' || event.error === 'audio-capture') {
                   // Don't treat no-speech as a fatal error, just restart.
                } else {
                   updateStatus('Error');
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                // Keep listening if activated
                if (isActivated && !synth.speaking) {
                   updateStatus('Thinking');
                   setTimeout(() => {
                       if(isActivated) startListening();
                   }, 500); // Small delay before restarting
                } else if (!isActivated) {
                    updateStatus('Deactivated');
                }
            };
        }

        // --- Command Processing ---
        async function processCommand(command) {
            updateStatus('Processing');

            if (command.includes('shutdown') || command.includes('goodbye') || command.includes('deactivate')) {
                speak("Goodbye, sir.", () => {
                     isActivated = false;
                     startBtn.textContent = 'ACTIVATE J.A.R.V.I.S.';
                     updateStatus('Deactivated');
                });
                return;
            }

            // Hardcoded commands
            if (command.includes('what time is it')) {
                const time = new Date().toLocaleTimeString();
                speak(`The current time is ${time}`);
                addLog('J.A.R.V.I.S.', `The current time is ${time}.`);
                return;
            }

            if (command.includes('what is the date')) {
                const date = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
                speak(`Today is ${date}`);
                addLog('J.A.R.V.I.S.', `Today is ${date}.`);
                return;
            }

            if (command.startsWith('search for')) {
                const query = command.substring('search for'.length).trim();
                speak(`Searching Google for ${query}`);
                addLog('J.A.R.V.I.S.', `Searching Google for: ${query}.`);
                window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                return;
            }
            
            if (command.includes('tell me a joke')) {
                const jokes = [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "I told my wife she was drawing her eyebrows too high. She looked surprised.",
                    "Why did the scarecrow win an award? Because he was outstanding in his field."
                ];
                const joke = jokes[Math.floor(Math.random() * jokes.length)];
                speak(joke);
                addLog('J.A.R.V.I.S.', joke);
                return;
            }

            // If no hardcoded command matches, use Gemini
            try {
                const geminiResponse = await getGeminiResponse(command);
                speak(geminiResponse);
                addLog('J.A.R.V.I.S.', geminiResponse);
            } catch (error) {
                console.error("Error fetching from Gemini:", error);
                const errorMessage = "I'm sorry, I seem to be having trouble connecting to my core programming. Please try again later.";
                speak(errorMessage);
                addLog('J.A.R.V.I.S.', errorMessage);
            }
        }
        
        // --- Gemini API Call with Exponential Backoff ---
        async function getGeminiResponse(prompt, retries = 3, delay = 1000) {
            const systemPrompt = "You are J.A.R.V.I.S., Tony Stark's AI assistant. Your responses should be concise, helpful, and have a slightly formal, yet witty, tone. Do not use markdown or formatting. Address the user as 'sir'.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                   if (response.status === 429 && retries > 0) { // Throttling
                        await new Promise(res => setTimeout(res, delay));
                        return getGeminiResponse(prompt, retries - 1, delay * 2);
                   }
                   throw new Error(`API responded with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error("Invalid response structure from API.");
                }
                
                return text;

            } catch (error) {
                 if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return getGeminiResponse(prompt, retries - 1, delay * 2);
                }
                console.error("API call failed after multiple retries:", error);
                throw error;
            }
        }
        

        // --- Event Listeners ---
        startBtn.addEventListener('click', () => {
            if (!isActivated) {
                isActivated = true;
                startBtn.textContent = 'DEACTIVATE J.A.R.V.I.S.';
                addLog('System', 'J.A.R.V.I.S. activated.');
                speak("At your service, sir.", () => {
                    startListening();
                });
                setupRecognition(); // Setup listeners once
            } else {
                isActivated = false;
                startBtn.textContent = 'ACTIVATE J.A.R.V.I.S.';
                addLog('System', 'J.A.R.V.I.S. deactivated.');
                recognition.stop();
                updateStatus('Deactivated');
            }
        });
    </script>
</body>
</html>

